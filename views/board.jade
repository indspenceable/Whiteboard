doctype 5
html(lang="en")
  head
    title Whiteboard
    script(src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js")
    script(src="/socket.io/socket.io.js")
    script
      var drawing = false
      var buffer = []
      var canvas
      var context 
      var canvasOffsetX
      var canvasOffsetY
      var lastLocallyCapturedPoint
      
      
      function mouseUp() {
        drawing=false
      }
      function mouseDown() {
        drawing = true
      }
      
      function drawInLine(p) {
        var xd = lastLocallyCapturedPoint.x-p.x
        var yd = lastLocallyCapturedPoint.y-p.y
        var steps = Math.abs(xd) + Math.abs(yd) / 5
        for (var i = 0; i < steps; i++) {
          var point = {x:Math.floor(p.x + i*(xd) / steps), y:Math.floor(p.y + i*(yd) / steps)}
          draw(point)
          buffer.push(point)
        }
      }
      
      function mouseMove(event) {
        var point = {x:event.pageX - canvasOffsetX, y:event.pageY - canvasOffsetY}
        if(drawing) {
          drawInLine(point)
        }
        lastLocallyCapturedPoint = point
      }
      function draw(point) {
        context.fillRect(point.x, point.y,5,5)
      }
      $(function() {
        canvas = $('canvas')
        canvasOffsetX = canvas.offset().left
        canvasOffsetY = canvas.offset().top
        context = canvas.get(0).getContext('2d')
        context.fillStyle = '#000'
        
        $(document).mouseup(mouseUp).mousedown(mouseDown).mousemove(mouseMove)
        
        var socket = io.connect();
        socket.emit('join', {board: "#{board}"})
        
        socket.on('draw', function(data){
          data.points.forEach(draw)
        })
        setInterval(function() {
          if(buffer.length > 0) {
            socket.emit('draw', {points: buffer})
            buffer = []
          }
        }, 20)
      })

  body
    h1 #{board}
    canvas(width="500px", height="500px", style="border: 1px solid black")